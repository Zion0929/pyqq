<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <title>æœ‹å‹åœˆ</title>
    <link href="../../css/common.css" rel="stylesheet" />
    <link href="../../css/moments.css" rel="stylesheet" />
    <style type="text/css">
        .moments-header {
            height: 240px;
            background-color: #000;
            position: relative;
            overflow: hidden;
        }
        
        .moments-cover {
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0.8;
        }
        
        .user-info {
            position: absolute;
            bottom: 15px;
            right: 15px;
            display: flex;
            align-items: center;
            z-index: 2;
        }
        
        .user-name {
            color: #fff;
            font-size: 16px;
            font-weight: bold;
            margin-right: 10px;
            text-shadow: 0 0 3px rgba(0, 0, 0, 0.5);
        }
        
        .user-avatar {
            width: 70px;
            height: 70px;
            border-radius: 5px;
            border: 2px solid rgba(255, 255, 255, 0.8);
            overflow: hidden;
        }
        
        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .moments-container {
            background-color: #fff;
            padding-bottom: 20px;
        }
        
        .moment-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .moment-header {
            display: flex;
            margin-bottom: 10px;
        }
        
        .moment-avatar {
            width: 40px;
            height: 40px;
            border-radius: 3px;
            margin-right: 10px;
            overflow: hidden;
        }
        
        .moment-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .moment-info {
            flex: 1;
        }
        
        .moment-name {
            font-size: 16px;
            font-weight: bold;
            color: #576b95;
            margin-bottom: 2px;
        }
        
        .moment-time {
            font-size: 12px;
            color: #999;
        }
        
        .moment-content {
            margin-left: 50px;
            margin-bottom: 10px;
        }
        
        .moment-text {
            font-size: 15px;
            line-height: 1.5;
            margin-bottom: 10px;
            word-break: break-word;
        }
        
        .moment-images {
            display: flex;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }
        
        .moment-image {
            width: calc(33.333% - 6px);
            margin-right: 8px;
            margin-bottom: 8px;
            background-color: #f1f1f1;
            position: relative;
            overflow: hidden;
        }
        
        .moment-image:nth-child(3n) {
            margin-right: 0;
        }
        
        .moment-image::before {
            content: "";
            display: block;
            padding-top: 100%;
        }
        
        .moment-image img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .moment-video {
            width: 100%;
            max-width: 300px;
            height: 200px;
            background-color: #000;
            margin-bottom: 10px;
        }
        
        .moment-actions {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            margin-left: 50px;
        }
        
        .moment-like, .moment-comment {
            font-size: 14px;
            color: #576b95;
            margin-left: 15px;
            cursor: pointer;
        }
        
        .moment-comments {
            margin-left: 50px;
            margin-top: 10px;
            background-color: #f7f7f7;
            border-radius: 3px;
            padding: 8px 10px;
        }
        
        .comment-item {
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 5px;
        }
        
        .comment-name {
            color: #576b95;
            font-weight: bold;
        }
        
        .publish-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background-color: #07c160;
            color: #fff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }
    </style>
</head>
<body>
    <div class="header-bar">
        <div class="header-left"></div>
        <div class="header-title">æœ‹å‹åœˆ</div>
        <div class="header-right" id="refreshBtn">ğŸ”„</div>
    </div>
    
    <div class="content-view">
        <div class="moments-header">
            <img src="../../static/img/moments-cover.jpg" class="moments-cover" onerror="this.src='../../static/img/default-cover.jpg'">
            <div class="user-info">
                <div class="user-name">æˆ‘</div>
                <div class="user-avatar">
                    <img src="../../static/img/user-avatar.jpg" onerror="this.src='../../static/img/default-avatar.jpg'">
                </div>
            </div>
        </div>
        
        <div class="moments-container" id="momentsList">
            <!-- æœ‹å‹åœˆå†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>
    
    <div class="publish-btn" id="publishBtn">+</div>
    
    <script src="../../js/storage.js"></script>
    <script src="../../js/api.js"></script>
    <script src="../../js/moments.js"></script>
    <script type="text/javascript">
        var userId = 'user1'; // å½“å‰ç”¨æˆ·ID
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ–å­˜å‚¨
            initStorage().then(function() {
                // åŠ è½½æœ‹å‹åœˆ
                loadMoments();
            });
            
            // è®¾ç½®å‘å¸ƒæŒ‰é’®ç‚¹å‡»äº‹ä»¶
            document.getElementById('publishBtn').addEventListener('click', function() {
                window.location.href = 'publish.html';
            });
            
            // è®¾ç½®åˆ·æ–°æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            document.getElementById('refreshBtn').addEventListener('click', function() {
                loadMoments();
                showToast('åˆ·æ–°æˆåŠŸ');
            });
        });
        
        // åŠ è½½æœ‹å‹åœˆ
        function loadMoments() {
            // æ˜¾ç¤ºåŠ è½½ä¸­
            var momentsList = document.getElementById('momentsList');
            momentsList.innerHTML = '<div class="loading"><div class="loading-spinner"></div></div>';
            
            // è·å–æœ‹å‹åœˆå†…å®¹
            getMoments().then(function(moments) {
                // æ’åºï¼Œæœ€æ–°çš„åœ¨å‰é¢
                moments.sort(function(a, b) {
                    return b.timestamp - a.timestamp;
                });
                
                renderMoments(moments);
                
                // åŠ è½½AIè¯„è®º
                loadAiComments();
            }).catch(function(error) {
                console.error('åŠ è½½æœ‹å‹åœˆå¤±è´¥:', error);
                showToast('åŠ è½½æœ‹å‹åœˆå¤±è´¥');
                
                momentsList.innerHTML = '<div style="text-align:center;padding:20px;color:#999;">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</div>';
            });
        }
        
        // æ¸²æŸ“æœ‹å‹åœˆ
        function renderMoments(moments) {
            var momentsList = document.getElementById('momentsList');
            momentsList.innerHTML = '';
            
            if (moments.length === 0) {
                momentsList.innerHTML = '<div style="text-align:center;padding:20px;color:#999;">æš‚æ— æœ‹å‹åœˆå†…å®¹</div>';
                return;
            }
            
            moments.forEach(function(moment) {
                var momentElement = createMomentElement(moment);
                momentsList.appendChild(momentElement);
            });
        }
        
        // åˆ›å»ºæœ‹å‹åœˆå…ƒç´ 
        function createMomentElement(moment) {
            var momentDiv = document.createElement('div');
            momentDiv.className = 'moment-item';
            momentDiv.setAttribute('data-id', moment.id);
            
            var avatar = moment.userId === userId ? '../../static/img/user-avatar.jpg' : 
                                                    '../../static/img/avatar' + (parseInt(moment.userId.replace('ai', '')) || 1) + '.jpg';
            var name = moment.userId === userId ? 'æˆ‘' : moment.userName || 'AIå¥½å‹';
            
            // æ„å»ºHTMLç»“æ„
            var html = `
                <div class="moment-header">
                    <div class="moment-avatar">
                        <img src="${avatar}" onerror="this.src='../../static/img/default-avatar.jpg'">
                    </div>
                    <div class="moment-info">
                        <div class="moment-name">${name}</div>
                        <div class="moment-time">${formatTime(moment.timestamp)}</div>
                    </div>
                </div>
                <div class="moment-content">
                    <div class="moment-text">${moment.content}</div>
            `;
            
            // å›¾ç‰‡å†…å®¹
            if (moment.images && moment.images.length > 0) {
                html += '<div class="moment-images">';
                moment.images.forEach(function(image) {
                    html += `
                        <div class="moment-image">
                            <img src="${image}" onerror="this.src='../../static/img/image-error.jpg'">
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            // è§†é¢‘å†…å®¹
            if (moment.video) {
                html += `
                    <video class="moment-video" controls>
                        <source src="${moment.video}" type="video/mp4">
                        æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾
                    </video>
                `;
            }
            
            html += '</div>';
            
            // æ“ä½œåŒºåŸŸ
            html += `
                <div class="moment-actions">
                    <div class="moment-like" onclick="likeMoment('${moment.id}')">ğŸ‘ ç‚¹èµ</div>
                    <div class="moment-comment" onclick="showCommentInput('${moment.id}')">ğŸ’¬ è¯„è®º</div>
                </div>
            `;
            
            // è¯„è®ºåŒºåŸŸ
            if (moment.comments && moment.comments.length > 0) {
                html += '<div class="moment-comments">';
                moment.comments.forEach(function(comment) {
                    var commentName = comment.userId === userId ? 'æˆ‘' : comment.userName || 'AIå¥½å‹';
                    html += `
                        <div class="comment-item">
                            <span class="comment-name">${commentName}ï¼š</span>${comment.content}
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            momentDiv.innerHTML = html;
            return momentDiv;
        }
        
        // åŠ è½½AIè¯„è®º
        function loadAiComments() {
            // è·å–AIå¥½å‹
            getAiFriends().then(function(friends) {
                // è·å–æœ€è¿‘å‘å¸ƒçš„æœ‹å‹åœˆ
                getMoments().then(function(moments) {
                    // ç­›é€‰å‡ºç”¨æˆ·å‘å¸ƒçš„ã€å°šæœªæœ‰è¶³å¤ŸAIè¯„è®ºçš„æœ‹å‹åœˆ
                    var userMoments = moments.filter(function(moment) {
                        return moment.userId === userId && 
                               (!moment.comments || moment.comments.filter(function(c) { return c.userId !== userId; }).length < 2);
                    });
                    
                    userMoments.forEach(function(moment) {
                        // ä¸ºæ¯ä¸ªAIå¥½å‹éšæœºé€‰æ‹©æ˜¯å¦è¯„è®ºï¼ˆè¿™é‡Œç¤ºä¾‹50%æ¦‚ç‡è¯„è®ºï¼‰
                        friends.forEach(function(friend) {
                            if (Math.random() > 0.5) {
                                // è¯¥AIå¥½å‹æ˜¯å¦å·²ç»è¯„è®ºè¿‡
                                var hasCommented = moment.comments && moment.comments.some(function(c) {
                                    return c.userId === friend.id;
                                });
                                
                                if (!hasCommented) {
                                    // å‘é€è¯·æ±‚è·å–AIè¯„è®º
                                    getAiComment(friend, moment).then(function(commentContent) {
                                        if (commentContent) {
                                            // åˆ›å»ºè¯„è®ºå¯¹è±¡
                                            var comment = {
                                                id: generateId(),
                                                momentId: moment.id,
                                                userId: friend.id,
                                                userName: friend.name,
                                                content: commentContent,
                                                timestamp: Date.now()
                                            };
                                            
                                            // ä¿å­˜è¯„è®º
                                            addMomentComment(comment).then(function() {
                                                // åˆ·æ–°æœ‹å‹åœˆ
                                                loadMoments();
                                            });
                                        }
                                    }).catch(function(error) {
                                        console.error('è·å–AIè¯„è®ºå¤±è´¥:', error);
                                    });
                                }
                            }
                        });
                    });
                });
            });
        }
        
        // ç‚¹èµæœ‹å‹åœˆ
        function likeMoment(momentId) {
            showToast('ç‚¹èµæˆåŠŸ');
            // å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œåº”è¯¥å®ç°ç‚¹èµé€»è¾‘
        }
        
        // æ˜¾ç¤ºè¯„è®ºè¾“å…¥æ¡†
        function showCommentInput(momentId) {
            var content = prompt('è¯·è¾“å…¥è¯„è®ºå†…å®¹');
            if (content && content.trim()) {
                // åˆ›å»ºè¯„è®ºå¯¹è±¡
                var comment = {
                    id: generateId(),
                    momentId: momentId,
                    userId: userId,
                    userName: 'æˆ‘',
                    content: content.trim(),
                    timestamp: Date.now()
                };
                
                // ä¿å­˜è¯„è®º
                addMomentComment(comment).then(function() {
                    // åˆ·æ–°æœ‹å‹åœˆ
                    loadMoments();
                    showToast('è¯„è®ºæˆåŠŸ');
                }).catch(function(error) {
                    console.error('è¯„è®ºå¤±è´¥:', error);
                    showToast('è¯„è®ºå¤±è´¥');
                });
            }
        }
        
        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(timestamp) {
            var now = new Date();
            var date = new Date(timestamp);
            var diff = now - date;
            
            // å°äº1åˆ†é’Ÿ
            if (diff < 60 * 1000) {
                return 'åˆšåˆš';
            }
            
            // å°äº1å°æ—¶
            if (diff < 60 * 60 * 1000) {
                return Math.floor(diff / (60 * 1000)) + 'åˆ†é’Ÿå‰';
            }
            
            // å°äº24å°æ—¶
            if (diff < 24 * 60 * 60 * 1000) {
                return Math.floor(diff / (60 * 60 * 1000)) + 'å°æ—¶å‰';
            }
            
            // å°äº30å¤©
            if (diff < 30 * 24 * 60 * 60 * 1000) {
                return Math.floor(diff / (24 * 60 * 60 * 1000)) + 'å¤©å‰';
            }
            
            // å¤§äº30å¤©ï¼Œæ˜¾ç¤ºå…·ä½“æ—¥æœŸ
            var year = date.getFullYear();
            var month = (date.getMonth() + 1).toString().padStart(2, '0');
            var day = date.getDate().toString().padStart(2, '0');
            return year + '-' + month + '-' + day;
        }
        
        // ç”Ÿæˆå”¯ä¸€ID
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }
        
        // æ˜¾ç¤ºToastæç¤º
        function showToast(message) {
            var toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(function() {
                document.body.removeChild(toast);
            }, 1500);
        }
    </script>
</body>
</html> 